<!DOCTYPE html>
<html id="$katjusha" lang="ja">
<head id="$head">
  <base id="$base" href="http://localhost/katjusha/">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="test/katjusha.css">
  <link rel="icon" href="test/favicon.png">
  <title id="$title">かちゅぼ～ど</title>
</head>
<body id="$body">


<toolbar id="$toolbar">
<tool-icons>
  <button id="$オンラインアイコン"></button>
  <button id="$セーブアイコン"></button>
  <icon-separate></icon-separate>
  <button id="$検索アイコン"></button>
  <button id="$巡回アイコン"></button>
  <button id="$スレッド投稿アイコン" title="新規スレッド書き込み" command="show-modal" commandfor="$dialog"></button>
  <icon-separate></icon-separate>
  <button id="$ペインアイコン"></button>
  <button id="$グリッド1アイコン"></button>
  <button id="$グリッド2アイコン"></button>
  <button id="$グリッド3アイコン"></button>
  <icon-separate></icon-separate>
  <button id="$設定アイコン"></button>
  <button id="$ヘルプアイコン" title="ヘルプ"></button>
  <icon-separate></icon-separate>
</tool-icons>
<board-buttons>
  <button id="$全板ボタン">▽</button>
</board-buttons>
<anime id="$anime" data-ajax="0"></anime>
</toolbar>


<border></border>


<bbs id="$bbs" onclick="$bbs.select(event.target.href)" oncontextmenu="$bbs.contextmenu(event, event.target)">
  <details open>
    <summary>カテゴリ1</summary>
    <a href="http://localhost/katjusha/a/">掲示板a</a>
    <a href="http://localhost/katjusha/b/">掲示板b</a>
  </details>
  <details open>
    <summary>カテゴリ2</summary>
    <a href="http://localhost/katjusha/c/">掲示板c</a>
  </details>
</bbs>

<subject id="$subject" oncontextmenu="event.preventDefault()">
<table>
  <thead ondblclick="$subject.sort(event.target)">
    <tr><th>No.</th><th>タイトル</th><th>レス</th><th>既得</th><th>新着</th><th>最終取得</th><th>最終書き込み</th><th></th></tr>
  </thead>
  <tbody id="$tbody" oncontextmenu="$tbody.contextmenu(event)" onmousedown="$tbody.select(event)">
  </tbody>
</table>
</subject>

<headline id="$headline" oncontextmenu="event.preventDefault()">
<header>
  <headline-bbs id="$headlineBBS"></headline-bbs>
  <headline-title id="$headlineTitle"></headline-title>
</header>
<thread-icons>
  <button id="$リストアイコン"></button>
  <icon-separate></icon-separate>
  <button id="$レス更新アイコン" title="レスを取得"></button>
  <button id="$中止アイコン" title="レス受信中止"></button>
  <icon-separate></icon-separate>
  <button id="$レス投稿アイコン" title="レス書き込み" command="show-modal" commandfor="$dialog"></button>
  <button id="$お気に入りアイコン"></button>
  <icon-separate></icon-separate>
  <button id="$ごみ箱アイコン" title="ログ削除"></button>
  <button id="$タブ閉じるアイコン" title="タブを閉じる"></button>
</thread-icons>
</headline>

<tabs id="$tab" ondblclick="$katjusha.link(event.target.className)" onclick="$tab.select(event.target)" oncontextmenu="$tab.contextmenu(event)">
  <tab id="$tabActive"></tab>
</tabs>

<threads id="$thread" onclick="$thread.clicked(event)">
  <thread id="$threadActive"></thread>
</threads>

<status id="$status"></status>


<dialog id="$dialog">
  <header onpointermove="$dialog.move(event)">
    <h1 id="$dialogTitle"></h1>
    <button command="close" commandfor="$dialog"></button>
  </header>
  <ul>
    <li class="selected">書き込み</li>
    <li>ローカルルール</li>
  </ul>
  <form id="$form" action="test/bbs.cgi" method="POST" spellcheck="false">
    <table>
      <tr>
        <th>タイトル</th>
        <td colspan="4"><input type="text" name="subject"></td></tr>
      <tr>
        <th>名前</th>
        <td><input type="text" name="FROM"></td>
        <th>メール</th>
        <td><input type="text" name="mail"></td>
        <td><label><input type="checkbox" name="sage">sage</label></td></tr>
    </table>
    <textarea name="MESSAGE"></textarea>
    <input type="submit" name="submit" value="書き込む">
    <input type="hidden" name="bbs">
    <input type="hidden" name="key">
  </form>
</dialog>

<contextmenu id="$contextmenu" oncontextmenu="event.preventDefault()" popover></contextmenu>

<popup id="$popup" popover></popup>



<script type="module">

$katjusha.start = function(){
    $bbs.init()
    $base.title = document.title
    $全板ボタン.textContent = `▽${document.title}`
    $katjusha.aborts = new Set

    if($base.href !== document.URL){
        $katjusha.link(document.URL)
    }
}

$katjusha.onclick = function(event){
    const {href, target} = event.target

    if(!href) return
    else if(href === $base.href){
        event.preventDefault()
        history.replaceState(null, null, href)
    }
    else if(URLisBBS(href)){
        event.preventDefault()
        $katjusha.fetch(`${href}subject.txt`).then(r => $subject.recieve(r, href))
    }
    else if(URLisThread(href)){
        event.preventDefault()
        const data    = スレッド[href]
        const headers = data.etag ? {'If-None-Match':data.etag, 'Range':`bytes=${data.byte}-`} : {}

        $tab.open(href, target, data)
        $tab.loading(href)
        $katjusha.fetch(data.daturl, {headers}).then(r => $thread.recieve(r, data)).finally(_=> $tab.loading(data.url, false))
    }
}

$katjusha.fetch = async function(url, option){
    const {hostname} = new URL(url)
    const abort      = new AbortController()

    try{
        $anime.dataset.ajax++
        $katjusha.aborts.add(abort)
        $status.textContent = `${hostname}に接続しています`
        const response   = await fetch(url, {cache:'no-store', signal:abort.signal, ...option})
        response.content = new TextDecoder('shift-jis').decode(await response.arrayBuffer())
        response.byte    = Number(response.headers.get('Content-Length'))
        response.etag    = response.headers.get('ETag')?.replace('W/', '').replace('-gzip', '')
        $status.textContent = `${hostname}に接続しました`

        return response
    }
    catch(error){ // DNSエラー・CORSエラー・Abortの時のみ来る。404の時は来ない。
        $status.textContent = error.name === 'AbortError' ? `` : `${hostname}に接続できませんでした`
        return error
    }
    finally{
        $anime.dataset.ajax--
        $katjusha.aborts.delete(abort)
    }
}

$katjusha.link = function(href, target){
    $katjusha.href   = href
    $katjusha.target = target
    $katjusha.click()
}


$bbs.init = function(){
    let category = ''
    for(const el of $('*summary, a', this)){
        if(el.tagName === 'A'){
            const url = el.href
            $bbs[url] = {category, url, el, name:el.textContent, ...URLparseBBS(url)}
        }
        else{
            category  = el.textContent
        }
    }
}

$bbs.select = function(url){
    if(this[url]){
        if(window.$bbsActive){
            $bbsActive.id  = ""
        }
        this[url].el.id = "$bbsActive"
    }
}

$bbs.contextmenu = function(event, a){
    event.preventDefault()
    event.stopPropagation()

    if(a.tagName !== 'A') return

    this.select(a.href)
    $contextmenu.show(event, {
        'URLをコピー'           : _=> clipboard(a.href),
        '掲示板名とURLをコピー' : _=> clipboard(`${a.innerHTML}\n${a.href}\n`),
    })
}

$subject.recieve = function(response, url){
    $tbody.textContent = ''
    if(response.status !== 200) return

    $bbs.select(url)
    $tbody.innerHTML = response.content.trim().split('\n').map(this.toHTML).join('')
    $title.textContent = `${$base.title} [ ${$bbs[url].name} ]`
    $status.textContent = `${$tbody.rows.length}件のスレッドを受信 (${date()})`
    history.replaceState(null, null, url)
}


$subject.toHTML = function(line, i){
    const [, key, subject, num] = line.match(/(\d+)\.dat<>(.+?) \((\d+)\)$/)
    const url  = URLbuild($bbsActive.href, key)
    const data = スレッド[url]

    data.subject = subject
    if(data.num === data.既得){
        data.新着 = 0
    }

    return `
        <tr class="${url}">
          <td>${i+1}</td>
          <td><a href="${url}">${subject}</a></td>
          <td>${num}</td>
          <td>${data.既得 || ''}</td>
          <td>${data.新着 || ''}</td>
          <td>${data.最終取得}</td>
          <td>${data.最終書き込み}</td>
          <td></td>
        </tr>`
}


$subject.select = function(el){
    if(window.$subjectActive){
        $subjectActive.id  = ""
    }
    el.id = "$subjectActive"
}


$subject.update = function(data){
    const tr = $(`tr[class="${data.url}"]`, this)
    if(!tr) return

    tr.cells[2].textContent = data.num || ''
    tr.cells[3].textContent = data.既得 || ''
    tr.cells[4].textContent = data.新着 || ''
    tr.cells[5].textContent = data.最終取得 || ''
    tr.cells[6].textContent = data.最終書き込み || ''
    this.select(tr)
}

$subject.sort = function(th){
    this.cmp ??= new Intl.Collator('ja-JP', {numeric:true}).compare
    th.order = th.order ? -th.order : -1
    const i  = th.cellIndex
    const tr = [...$tbody.rows].sort((a, b) => this.cmp(a.cells[i].textContent, b.cells[i].textContent)*th.order)

    $tbody.append(...tr)
}

$tbody.select = function(event){
    const tr = event.target.closest('tr')

    if(event.button === 0 && event.target.cellIndex < 7){
        event.preventDefault()
        $subject.select(tr)
        $katjusha.link(tr.className)
    }
}

$tbody.contextmenu = function(event){
    const tr  = event.target.closest('tr')
    const url = tr.className

    $subject.select(tr)
    $contextmenu.show(event, {
        '新しいタブで開く'      : _=> $katjusha.link(url, '_blank'),
        'URLをコピー'           : _=> clipboard(url),
        'タイトルとURLをコピー' : _=> clipboard(`${tr.cells[1].textContent}\n${url}\n`),
    })
}



$headline.render = function(data){
    $headlineBBS.innerHTML   = `<a href="${data.bbsurl}">[${data.bbsname}]</a>`
    $headlineTitle.innerHTML = `${data.subject} (${data.num})`
}

$レス更新アイコン.onclick = function(event){
    $katjusha.link($tabActive.className)
}

$中止アイコン.onclick = function(event){
    $katjusha.aborts.forEach(v => v.abort())
}

$ごみ箱アイコン.onclick = function(event){
    const url = $tabActive.className

    if(スレッド[url]){
        $status.textContent = `「${スレッド[url].subject}」のログを削除しました`
        delete スレッド[url]
    }
}

$タブ閉じるアイコン.onclick = function(event){
    $tab.close($tabActive)
}



$tab.open = function(url, target, data = {}){
    const tab = $tab.get(url)

    if(tab){
        this.select(tab)
    }
    else if(!$tabActive.className || !target){
        $tabActive.className      = url
        $tabActive.innerHTML      = data.subject || ''
        $threadActive.className   = url
        $threadActive.innerHTML   = data.html || ''
    }
    else{
        const newtab = $.tab(data.subject, {'class':url})
        const thread = $.thread(data.html, {'class':url})
        $tab.append(newtab)
        $thread.append(thread)
        this.select(newtab)
    }
}

$tab.render = function(url, data = ''){
    const tab    = $tab.get(url)
    const thread = $thread.children[brosNo(tab)]

    if(typeof data === 'object'){
        tab.innerHTML    = data.subject
        tab.className    = url
        thread.innerHTML = data.html
        thread.className = url
    }
    else{
        thread.innerHTML  += data
    }

    $tab.select(tab)
}

$tab.select = function(tab){
    if(!tab || tab.tagName !== 'TAB' || tab === $tabActive) return

    const thread = $thread.children[brosNo(tab)]
    const url    = tab.className

    $tabActive.id  = $threadActive.id = ""
    tab.id    = "$tabActive"
    thread.id = "$threadActive"

    if(!url) return

    const data = スレッド[url]
    $title.textContent = data.subject
    $headline.render(data)
    history.replaceState(null, null, url)
}


$tab.loading = function(url, bool = true){
    $tab.get(url)?.toggleAttribute('loading', bool)
}

$tab.get = function(url){
    return $(`tab[class="${url}"]`, this)
}


$tab.close = function(tab){
    if($tab.childElementCount === 1) return

    this.select(tab.nextElementSibling ?? tab.previousElementSibling)
    $thread.children[brosNo(tab)].remove()
    tab.remove()
}

$tab.closeElse = function(tab){
    [...$tab.children].forEach(el => el !== tab && $tab.close(el))
}

$tab.contextmenu = function(event){
    event.preventDefault()
    event.stopPropagation()

    if(event.target.tagName !== 'TAB') return

    const url = event.target.className
    $contextmenu.show(event, {
        '閉じる'                 : _=> $tab.close(event.target),
        'このタブ以外全て閉じる' : _=> $tab.closeElse(event.target),
        'URLをコピー'            : _=> clipboard(url),
        'タイトルとURLをコピー'  : _=> clipboard(`${event.target.innerHTML}\n${url}\n`),
    })
}


$thread.recieve = function(response, data){

    if(response.status === 200){
        const dat = this.parse(response.content)

        data.subject = dat.subject
        data.html    = dat.html
        data.num     = dat.num
        data.byte    = response.byte
        data.etag    = response.etag
        data.既得    = dat.num
        data.新着    = dat.num
        data.最終取得= date()

        $tab.render(data.url, data)
        $headline.render(data)
        $subject.update(data)
        $title.textContent  = data.subject
        $status.textContent = `${dat.num}のレスを受信 (${date()}) ${KB(data.byte)}`
    }
    else if(response.status === 206){
        const dat = this.parse(response.content, data.num)

        data.html   += dat.html
        data.num    += dat.num
        data.byte   += response.byte
        data.etag    = response.etag
        data.既得    = data.num
        data.新着    = dat.num
        data.最終取得= date()

        $tab.render(data.url, dat.html)
        $headline.render(data)
        $subject.update(data)
        $title.textContent  = data.subject
        $status.textContent = `${dat.num}のレスを受信 (${date()}) ${KB(data.byte)}`
    }
    else if(response.status === 304){
        data.新着  = 0

        $subject.update(data)
        $status.textContent = `新着なし (${date()}) ${KB(data.byte)}`
    }
    else if(response.status === 404){
        $status.textContent = `スレッドが見つかりません (${date()})`
    }
    else if(response.status === 416){
        delete スレッド[data.url]
        $katjusha.link(data.url)
        return
    }
    else{
        return
    }

    history.replaceState(null, null, data.url)
}


$thread.parse = function(text, n = 0){
    const dat = text.trim().split('\n')
    let  html = ''

    for(const v of dat){
        const [from, mail, date, message, subject] = v.split('<>')

        const messageHTML = message
        .replace(/&gt;&gt;([1-9]\d{0,3})/g, '<anchor data-n="$1" onmouseenter="$popup.show(event, $1)" onmouseleave="$popup.hidePopover()">&gt;&gt;$1</anchor>')
        .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>')
        .replace(/^ /, '')
        //datファイルにaタグが含まれる場合: replace(/<a (.+?)>(.+?)<\/a>/g, '$2')

        html += `
          <res data-n="${n}">
            <header><i>${++n}</i><from><b>${from}</b></from><time>${date}</time><address>${mail}</address></header>
            <p>${messageHTML}</p>
          </res>
        `
    }

    return {html, num:dat.length, subject:dat[0].split('<>').pop()}
}

$thread.clicked = function(event){
    if(event.target.tagName === 'I'){
        event.stopPropagation()
        $contextmenu.show(event, {'これにレス' : _=> $thread.resTo(event.target.textContent)})
    }
    else if(event.target.tagName === 'ANCHOR'){
        event.stopPropagation()
        this.goto(event.target.dataset.n)
    }
}

$thread.goto = function(n){
    $threadActive.children[n-1]?.scrollIntoView()
}


$thread.resTo = function(n){
    $レス投稿アイコン.click()
    $form.insert(`>>${n}\n`)
}



$dialog.onbeforetoggle = function(event){
    if(event.newState === "closed") return

    $form.reset()

    if(event.source === $スレッド投稿アイコン){
        $form.url = window.$bbsActive?.href
        if(!$form.url) return event.preventDefault()

        const data = $bbs[$form.url]
        $dialogTitle.textContent = `『${data.name}』に新規スレッド`
        $form.action             = `${data.baseurl}test/bbs.cgi`
        $form.bbs.value          = data.bbs
        $form.key.value          = ''
        $form.mail.readOnly      = false
        $form.subject.disabled   = false
        $form.subject.autofocus  = true
        $form.MESSAGE.autofocus  = false
    }
    else{
        $form.url = window.$tabActive?.className
        if(!$form.url) return event.preventDefault()

        const data = スレッド[$form.url]
        $dialogTitle.textContent = `「${data.subject}」にレス`
        $form.action             = `${data.baseurl}test/bbs.cgi`
        $form.bbs.value          = data.bbs
        $form.key.value          = data.key
        $form.subject.value      = data.subject
        $form.mail.readOnly      = false
        $form.subject.disabled   = true
        $form.subject.autofocus  = false
        $form.MESSAGE.autofocus  = true
    }
}


$dialog.move = function(event){
    if(!event.buttons) return

    event.target.setPointerCapture(event.pointerId)
    const {x, y, width, height} = this.getBoundingClientRect()
    this.style.inset  = `${clamp(0, y+event.movementY, innerHeight-height)}px 0 0 ${clamp(0, x+event.movementX, innerWidth-width)}px`
    this.style.margin = 0
}


$form.onsubmit = async function(event){
    event.preventDefault()
    $form.submit.disabled = true

    const res = await $katjusha.fetch($form.action, {method:'POST', body:new FormData($form)})

    $form.submit.disabled = false
    $status.textContent = ''

    if(!res.ok){
        alert('エラーが発生して投稿できませんでした')
    }
    else if(res.content.includes('ＥＲＲＯＲ！')){
        alert( res.content.match(/<b>(.+?)</i)[1] )
    }
    else{
        if($form.key.value){
            スレッド[$form.url].最終書き込み = date()
        }
        $dialog.close()
        $katjusha.link($form.url)
    }
}


$form.sage.onchange = function(event){
    $form.mail.value    = event.target.checked ? 'sage' : ''
    $form.mail.readOnly = event.target.checked
}

$form.insert = function(text){
    const pos = this.MESSAGE.selectionStart + text.length

    this.MESSAGE.setRangeText(text)
    this.MESSAGE.setSelectionRange(pos, pos)
    this.MESSAGE.focus()
}



$contextmenu.show = function(event, menu){
    const buttons = Object.keys(menu).map(k => $.button(k, {'.onclick':menu[k], command:'hide-popover', commandfor:'$contextmenu'}))
    const rect    = event.target.getBoundingClientRect()
    this.replaceChildren(...buttons)
    this.style.inset = `-${rect.bottom-event.y}px 0 0 -${rect.right-event.x}px`
    this.togglePopover({source:event.target})
}



$popup.show = function(event, n){
    const el = $threadActive.children[n-1]
    if(!el) return

    //const {left, width, top} = event.target.getBoundingClientRect()
    //new KatjushaPopup(el.outerHTML).show(left+width/2, innerHeight-top+6)
    //this.style.inset = `-${rect.bottom-event.y}px 0 0 -${rect.right-event.x}px`
    this.innerHTML = el.outerHTML
    this.togglePopover({source:event.target})
}



const スレッド = new Proxy({}, {get(target, url){
    if(url in target){
        return target[url]
    }

    const {bbs, key, bbsurl, baseurl} = URLparse(url)
    target[url] = {
        url     : url,
        key     : key,
        bbs     : bbs,
        bbsurl  : bbsurl,
        bbsname : $bbs[bbsurl].name,
        baseurl : baseurl,
        daturl  : `${bbsurl}dat/${key}.dat`,
        subject : '',
        html    : '',
        num     : 0,
        byte    : 0,
        etag    : '',
        scroll  : 0,
        既得    : 0,
        新着    : 0,
        最終取得: '',
        最終書き込み: '',
    }

    return target[url]
}})



const $ = new Proxy(proxySelector, {get: (_, name) => proxyElement.bind(name)})

function proxySelector(selector, context = document){
    return selector.startsWith('*') ? [...context.querySelectorAll(selector.slice(1)||'*')] : context.querySelector(selector)
}

function proxyElement(html, attr){
    const el = document.createElement( this.replaceAll('_', '-') )
    if(el.outerHTML.includes('/')){
        el.innerHTML = html ?? ''
    }
    else{
        attr = html
    }

    for(let name in attr ?? {}){
        if(name.startsWith('.')){
            el[name.slice(1)] = attr[name]
        }
        else{
            el.setAttribute(name, attr[name])
        }
    }

    return el
}

function date(){
    const d  = new Date()

    const 年 = d.getFullYear()
    const 月 = (d.getMonth()+1).toString().padStart(2, 0)
    const 日 = d.getDate().toString().padStart(2, 0)
    const 時 = d.getHours().toString().padStart(2, 0)
    const 分 = d.getMinutes().toString().padStart(2, 0)
    const 秒 = d.getSeconds().toString().padStart(2, 0)

    return `${年}/${月}/${日} ${時}:${分}:${秒}`
}

function KB(byte = 0){
    return Math.ceil(byte/1024) + 'KB'
}

function clamp(min, num, max){
    return Math.min(Math.max(min, num), max)
}

function URLbuild(bbsurl, key){
    return bbsurl.replace(/([^/]+)\/$/, `test/read.cgi/$1/${key}/`)
}

function URLparse(url){
    const [,baseurl,bbs,key] = url.match(/^(.+)test\/read\.cgi\/([^/]+)\/(\d+)\/$/)
    return {baseurl, bbs, key, bbsurl:`${baseurl}${bbs}/`}
}

function URLparseBBS(url){
    const [, baseurl, bbs] = url.match(/(.+\/)([^/]+)\/$/)
    return {baseurl, bbs}
}

function URLisThread(url=''){
    const m = url.match(/^(.+)test\/read\.cgi\/([^/]+)\/(\d+)\/$/)
    return m && URLisBBS(m[1]+m[2]+'/')
}

function URLisBBS(url=''){
    return url in $bbs
}


function brosNo(el){
    return [...el.parentElement.children].indexOf(el)
}

function clipboard(text){
    navigator.clipboard.writeText(text)
}


$katjusha.start()
</script>
